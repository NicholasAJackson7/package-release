name: Release Stable Version

on:
  workflow_dispatch:
    inputs:
      new_version:
        description: 'New version to release (e.g., 1.0.0)'
        required: true
        type: string
      previous_version:
        description: 'Previous version for changelog comparison (e.g., 0.1.0)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      pull-requests: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Validate versions
        run: |
          NEW_VERSION="${{ inputs.new_version }}"
          PREV_VERSION="${{ inputs.previous_version }}"
          
          if ! echo "$NEW_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "âŒ Invalid new version format: $NEW_VERSION"
            echo "Expected format: X.Y.Z (e.g., 1.0.0)"
            exit 1
          fi
          
          if ! echo "$PREV_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "âŒ Invalid previous version format: $PREV_VERSION"
            echo "Expected format: X.Y.Z (e.g., 0.1.0)"
            exit 1
          fi
          
          echo "âœ… New version: $NEW_VERSION"
          echo "âœ… Previous version: $PREV_VERSION"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@nicholasajackson7'

      - name: Update package.json version
        run: |
          npm version ${{ inputs.new_version }} --no-git-tag-version
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json
          git commit -m "chore: release v${{ inputs.new_version }}"
          git push

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Create Release Tag
        run: |
          git tag -a "v${{ inputs.new_version }}" -m "Release v${{ inputs.new_version }}"
          git push origin "v${{ inputs.new_version }}"

      - name: Generate release notes from PR labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PREV_TAG="v${{ inputs.previous_version }}"
          NEW_TAG="v${{ inputs.new_version }}"
          
          echo "Generating release notes from $PREV_TAG to $NEW_TAG"
          
          # Get the date of the previous tag (or repo creation if tag doesn't exist)
          if git rev-parse "$PREV_TAG" >/dev/null 2>&1; then
            SINCE_DATE=$(git log -1 --format=%aI "$PREV_TAG")
          else
            SINCE_DATE=$(git log --reverse --format=%aI | head -1)
          fi
          
          echo "Finding PRs merged since: $SINCE_DATE"
          
          # Get merged PRs since the previous release
          # Query PRs and extract their numbers, titles, authors, and labels
          gh pr list \
            --repo ${{ github.repository }} \
            --state merged \
            --search "merged:>=$SINCE_DATE" \
            --json number,title,author,labels \
            --limit 200 > prs.json
          
          echo "Found $(cat prs.json | jq length) merged PRs"
          
          # Create release notes file
          {
            echo "## What's Changed in v${{ inputs.new_version }}"
            echo ""
            
            # Breaking Changes
            BREAKING=$(cat prs.json | jq -r '.[] | select(.labels[].name | test("breaking"; "i")) | "- \(.title) (#\(.number)) @\(.author.login)"' 2>/dev/null | sort -u)
            if [ -n "$BREAKING" ]; then
              echo "### âš ï¸ Breaking Changes"
              echo "$BREAKING"
              echo ""
            fi
            
            # Features
            FEATURES=$(cat prs.json | jq -r '.[] | select(.labels[].name | test("feature"; "i")) | "- \(.title) (#\(.number)) @\(.author.login)"' 2>/dev/null | sort -u)
            if [ -n "$FEATURES" ]; then
              echo "### âœ¨ Features"
              echo "$FEATURES"
              echo ""
            fi
            
            # Bug Fixes
            BUGS=$(cat prs.json | jq -r '.[] | select(.labels[].name | test("bug"; "i")) | "- \(.title) (#\(.number)) @\(.author.login)"' 2>/dev/null | sort -u)
            if [ -n "$BUGS" ]; then
              echo "### ðŸ› Bug Fixes"
              echo "$BUGS"
              echo ""
            fi
            
            # Maintenance / Chores
            MAINTENANCE=$(cat prs.json | jq -r '.[] | select(.labels[].name | test("maintenance|chore|refactor"; "i")) | "- \(.title) (#\(.number)) @\(.author.login)"' 2>/dev/null | sort -u)
            if [ -n "$MAINTENANCE" ]; then
              echo "### ðŸ”§ Maintenance"
              echo "$MAINTENANCE"
              echo ""
            fi
            
            # Documentation
            DOCS=$(cat prs.json | jq -r '.[] | select(.labels[].name | test("documentation|docs"; "i")) | "- \(.title) (#\(.number)) @\(.author.login)"' 2>/dev/null | sort -u)
            if [ -n "$DOCS" ]; then
              echo "### ðŸ“š Documentation"
              echo "$DOCS"
              echo ""
            fi
            
            # Other (PRs without recognized labels)
            OTHER=$(cat prs.json | jq -r '.[] | select((.labels | length == 0) or ((.labels[].name | test("breaking|feature|bug|maintenance|chore|refactor|documentation|docs"; "i")) | not)) | "- \(.title) (#\(.number)) @\(.author.login)"' 2>/dev/null | sort -u)
            if [ -n "$OTHER" ]; then
              echo "### ðŸ“ Other Changes"
              echo "$OTHER"
              echo ""
            fi
            
            # If no PRs found at all, show commits
            if [ "$(cat prs.json | jq length)" -eq 0 ]; then
              echo "### ðŸ“ Changes"
              git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" 2>/dev/null || echo "- Initial release"
              echo ""
            fi
            
            echo ""
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${NEW_TAG}"
          } > release_notes.md
          
          echo "=== Generated Release Notes ==="
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.new_version }}
          name: v${{ inputs.new_version }}
          body_path: release_notes.md
          prerelease: false

      - name: Publish to GitHub Packages
        run: npm publish --tag latest
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Released v${{ inputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Previous version: v${{ inputs.previous_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- New version: v${{ inputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- npm tag: \`latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Notes" >> $GITHUB_STEP_SUMMARY
          cat release_notes.md >> $GITHUB_STEP_SUMMARY
