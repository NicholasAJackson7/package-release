name: Release Stable Version

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@nicholasajackson7'

      - name: Get previous stable version
        id: prev_version
        run: |
          # Find the most recent stable tag (no prerelease suffix)
          PREV_TAG=$(git tag -l 'v*' | grep -v '-' | sort -V | tail -n 1)
          if [ -z "$PREV_TAG" ]; then
            PREV_TAG="v0.0.0"
          fi
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous stable version: $PREV_TAG"

      - name: Calculate new stable version
        id: version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          # Strip any existing prerelease suffix to get base version
          BASE_VERSION=$(echo "$CURRENT_VERSION" | sed 's/-.*$//')
          
          IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"
          
          BUMP_TYPE="${{ inputs.version_type }}"
          
          if [ "$BUMP_TYPE" = "major" ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [ "$BUMP_TYPE" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [ "$BUMP_TYPE" = "patch" ]; then
            PATCH=$((PATCH + 1))
          fi
          
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "Releasing stable version: $NEW_VERSION (from $CURRENT_VERSION)"

      - name: Update package.json version
        run: |
          npm version ${{ steps.version.outputs.new }} --no-git-tag-version
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json
          git commit -m "chore: release v${{ steps.version.outputs.new }}"
          git push

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Create Release Tag
        run: |
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.tag }}"
          git push origin "${{ steps.version.outputs.tag }}"

      - name: Generate release notes
        id: release_notes
        run: |
          PREV_TAG="${{ steps.prev_version.outputs.tag }}"
          NEW_TAG="${{ steps.version.outputs.tag }}"
          
          echo "Generating release notes from $PREV_TAG to HEAD"
          
          # Create release notes file
          {
            echo "## What's Changed"
            echo ""
            
            # Get all commits since last stable release, group by type
            BREAKING=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --grep="^breaking" --regexp-ignore-case || true)
            FEATURES=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --grep="^feat" --regexp-ignore-case || true)
            FIXES=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --grep="^fix" --regexp-ignore-case || true)
            OTHER=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --grep="^chore\|^docs\|^style\|^refactor\|^perf\|^test" --regexp-ignore-case --invert-grep --grep="^feat\|^fix\|^breaking" || true)
            
            if [ -n "$BREAKING" ]; then
              echo "### âš ï¸ Breaking Changes"
              echo "$BREAKING"
              echo ""
            fi
            
            if [ -n "$FEATURES" ]; then
              echo "### âœ¨ Features"
              echo "$FEATURES"
              echo ""
            fi
            
            if [ -n "$FIXES" ]; then
              echo "### ðŸ› Bug Fixes"
              echo "$FIXES"
              echo ""
            fi
            
            # If no categorized commits, show all commits
            if [ -z "$BREAKING" ] && [ -z "$FEATURES" ] && [ -z "$FIXES" ]; then
              echo "### ðŸ“ Changes"
              git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" || echo "- Initial release"
              echo ""
            fi
            
            echo ""
            echo "**Full Changelog**: https://github.com/NicholasAJackson7/package-release/compare/${PREV_TAG}...${NEW_TAG}"
          } > release_notes.md
          
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          body_path: release_notes.md
          prerelease: false

      - name: Publish to GitHub Packages
        run: npm publish --tag latest
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Released ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Previous stable: ${{ steps.prev_version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- New version: ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- npm tag: \`latest\`" >> $GITHUB_STEP_SUMMARY

